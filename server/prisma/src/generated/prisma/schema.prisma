// users [icon: user, color: yellow]{
// id string pk
// username string unique
// email string unique
// password_hash string
// is_active boolean
// created_at timestamp
// updated_at timestamp
// last_login_at timestamp
// }

model User {
  id             Int            @id @default(autoincrement())
  username       String
  email          String         @unique
  password_hash  String
  is_active      Boolean
  created_at     DateTime       @default(now())
  updated_at     DateTime       @updatedAt
  last_login_at  DateTime       @default(now())
  role           Role
  sessions       Sessions[]
  leads          Lead[]
  notifications  Notification[]
  leadActivities LeadActivity[]
}

enum Role {
  Admin
  Owner
  Sales
  Finance
}

model Sessions {
  id            Int      @id @default(autoincrement())
  session_token String   @unique
  ip_address    String
  user_agent    String
  created_at    DateTime @default(now())
  expires_at    DateTime
  revoked_at    DateTime
  user_id       Int
  user          User     @relation(fields: [user_id], references: [id])
}

model Contact {
  id        Int      @id @default(autoincrement())
  firstName String
  lastName  String?
  email     String?  @unique
  phone     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  leads     Lead[]
}

model Lead {
  id                Int       @id @default(autoincrement())
  title             String?
  amount            Float     @default(0)
  status            String    @default("New")
  probability       Int?      @default(0)
  expectedCloseDate DateTime?
  notes             String?

  // Booking/Event fields
  guests        Int?
  venue         String?
  eventType     String?
  eventDate     DateTime?
  finalAmount   Float?
  advanceAmount Float?

  // Site visit fields
  siteVisitDate DateTime?
  siteVisitTime String?

  // Booking Details
  bookingNotes String?
  bookedAt     DateTime?
  bookedBy     String?

  // Relations
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contactId Int
  contact   Contact @relation(fields: [contactId], references: [id])

  sourceId Int?
  source   Sources? @relation(fields: [sourceId], references: [id])

  assignedTo Int?
  assignee   User? @relation(fields: [assignedTo], references: [id])

  activities    LeadActivity[]
  notifications Notification[]
  payments      Payment[]
}

model Payment {
  id        Int      @id @default(autoincrement())
  amount    Float
  date      DateTime @default(now())
  type      String   @default("Payment") // Advance, Mid-payment, Final, etc.
  notes     String?
  leadId    Int
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LeadActivity {
  id        Int      @id @default(autoincrement())
  leadId    Int
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id])
  type      String   @default("NOTE") // NOTE, STATUS_CHANGE, CALL, SYSTEM
  content   String
  createdAt DateTime @default(now())
}

model Sources {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  leads     Lead[]
}

model Notification {
  id        Int      @id @default(autoincrement())
  type      String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  userId Int?
  user   User? @relation(fields: [userId], references: [id])

  leadId Int?
  lead   Lead? @relation(fields: [leadId], references: [id])

  priority   String  @default("normal")
  assignedTo String? // for 'all' or specific role logic if not by userId
}

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}
